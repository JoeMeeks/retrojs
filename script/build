#!/bin/sh

source ~/emsdk_portable/emsdk_set_env.sh
CFLAGS='-Wall -Wno-unused-result -Wno-unused-variable -std=gnu99'

em++ -std=c++11 -c libretro.emscripten.cpp -o libretro.emscripten.bc -O3

for core in core/*
do
  emmake make -C $core -f Makefile.libretro || emmake make -C $core/libretro || emmake make -C $core || emmake make -C $core/libgambatte -f Makefile.libretro
  emcc libretro.emscripten.bc `find $core -name '*.bc' -print` --bind --memory-init-file 0 -O3 --pre-js pre.js --js-library glue.js -o $core/index.js -s NO_BROWSER=1 -s ALLOW_MEMORY_GROWTH=1 -s RESERVED_FUNCTION_POINTERS=20 -s EXPORTED_FUNCTIONS=@exports.json
done
