#!/bin/sh

SHELL_FILE="'`pwd`/shell.js'"
EXPORTS=`pwd`/exports.json

if test "$#" -gt 0; then
  cores=$@
else
  cores=core/*
fi

for core in $cores
do
  (cd $core && emmake make platform=emscripten)
done

for core in $cores
do
  BC_FILE=`find $core -name '*.bc' -print`
  DIR=`pwd`/$core
  (cd `dirname $BC_FILE` && emcc `basename $BC_FILE` -O3 -o ${DIR}/core.js --memory-init-file 0 -s RESERVED_FUNCTION_POINTERS=${RESERVED_FUNCTION_POINTERS-50} -s TOTAL_MEMORY=${TOTAL_MEMORY-268435456} -s EXPORTED_FUNCTIONS=@$EXPORTS -s SHELL_FILE=$SHELL_FILE -s NO_DYNAMIC_EXECUTION=1 -s NO_EXIT_RUNTIME=1)
  cp retro.js $core
done
